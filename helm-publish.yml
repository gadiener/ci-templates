
helm:publish:
  image: devth/helm:v3.1.1
  stage: push
  script:
    - |
      # CHECKING PHASE
      for var in "GOOGLE_KEY" "BUCKET_NAME" "GOOGLE_PROJECT"; do
          if [ -z "${!var}" ]; then
            echo
            echo "-> [WARNING] Missing '${var}' variable!"
            echo
            exit 1
          fi
      done
    - |
      # ACTIVATION PHASE

      echo "${GOOGLE_KEY}" > /tmp/key.json

      gcloud auth activate-service-account --key-file /tmp/key.json

      gcloud config set project "${GOOGLE_PROJECT}"

      echo
      echo "-> Google project '${GOOGLE_PROJECT}' configured!"
      echo
    - |
      # DEPLOY PHASE

      # Check if unset (but allow empty string)
      if [ -z "${BUCKET_PATH+x}" ]; then
        BUCKET_PATH="charts"
      fi

      # Check if not an empty string
      if [ ! "${BUCKET_PATH}" == "" ]; then
        BUCKET_PATH="/${BUCKET_PATH}"
      fi

      gsutil cp gs://"${BUCKET_NAME}${BUCKET_PATH}"/index.yaml /tmp/index.yaml

      helm package .
      helm repo index . --merge /tmp/index.yaml

      gsutil cp ./index.yaml gs://"${BUCKET_NAME}${BUCKET_PATH}"/index.yaml
      gsutil cp ./*.tgz* gs://"${BUCKET_NAME}${BUCKET_PATH}"/
  only:
    - /^v.+$/i
  except:
    - branches