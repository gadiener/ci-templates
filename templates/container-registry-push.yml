---
.container-registry:push:
  variables:
    GIT_STRATEGY: none

  before_script:
    - |
      # CHECK VARIABLES PHASE
      for var in "CONTAINER_REGISTRY_URL" "CONTAINER_REGISTRY_USERNAME" "CONTAINER_REGISTRY_PASSWORD" "GITLAB_CONTAINER_REGISTRY_IMAGE_FULL_PATH" "CONTAINER_REGISTRY_IMAGE_FULL_PATH" "IMAGE_TAG"; do
        if [ -z "${!var}" ]; then
          echo "Missing '${var}' Variable!"
          exit 1
        fi
      done

  script:
    - |
      # GITLAB CONTAINER REGISTRY LOGIN PHASE
      echo -n "${CI_REGISTRY_PASSWORD}" | docker login -u "${CI_REGISTRY_USER}" --password-stdin "${CI_REGISTRY}"

    - |
      # CONTAINER REGISTRY LOGIN PHASE
      echo -n "${CONTAINER_REGISTRY_PASSWORD}" | docker login -u "${CONTAINER_REGISTRY_USERNAME}" --password-stdin "${CONTAINER_REGISTRY_URL}"

    - |
      # DOCKER PUSH PHASE

      docker pull "${GITLAB_CONTAINER_REGISTRY_IMAGE_FULL_PATH}:${IMAGE_TAG}"
      docker tag "${GITLAB_CONTAINER_REGISTRY_IMAGE_FULL_PATH}:${IMAGE_TAG}" "${CONTAINER_REGISTRY_IMAGE_FULL_PATH}:${IMAGE_TAG}"
      docker push "${CONTAINER_REGISTRY_IMAGE_FULL_PATH}:${IMAGE_TAG}"
