notify_sentry:
  image: getsentry/sentry-cli:1.52.3
  stage: notify
  variables:
    ENVIRONMENT: "production"
  script:
    - |
      # CHECK VARIABLES PHASE
      for var in "SENTRY_AUTH_TOKEN" "SENTRY_URL" "SENTRY_ORG" "SENTRY_PROJECT"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done

      if [ -z "${CI_COMMIT_TAG}" ]; then
        CI_COMMIT_TAG=${CI_COMMIT_SHA}
        ENVIRONMENT="quality"
      fi

      sentry-cli info

      if [ -n "${FEAT_SENTRY_SETCOMMITS}" ]; then
        echo
        echo "-> [INFO] variable 'FEAT_SENTRY_SETCOMMITS' for experimental feature enabled!"
        echo
        sentry-cli releases new "${CI_COMMIT_TAG}"
        sentry-cli releases set-commits "${CI_COMMIT_TAG}" --auto
        sentry-cli releases finalize "$VERSION"
      else
        sentry-cli releases new --finalize "${CI_COMMIT_TAG}"
      fi

      sentry-cli releases deploys "${CI_COMMIT_TAG}" new -e "${ENVIRONMENT}"

      echo "Sentry was notified of the change!"
  when: on_success
  allow_failure: true
  only:
    - /^v.+$/i
    - master
