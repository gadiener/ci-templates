deploy:
  image: gdiener/ci-image-gcp:v1.0.1
  stage: deploy
  script:
    - &connection |
      # CLUSTER CONNECTION PHASE

      for var in "GOOGLE_KEY" "BUCKET_NAME" "GOOGLE_PROJECT"; do
          if [ -z "${!var}" ]; then
            echo
            echo "-> [WARNING] Missing '${var}' variable!"
            echo
            exit 1
          fi
      done

      echo "${GOOGLE_KEY}" > /tmp/key.json

      gcloud config set project "${GOOGLE_PROJECT}"

      gcloud auth activate-service-account --key-file /tmp/key.json
    - |
      # SYNCHRONIZING FILES IN THE BUCKET

      COMMAND_TO_RUN=( gsutil -m )

      if [ -z "${DIR_TO_SYNC}" ]; then
        DIR_TO_SYNC="public"
      fi

      if [ "${DIR_TO_SYNC}" = "copy" ]
        COMMAND_TO_RUN+=( cp )
      else
        COMMAND_TO_RUN+=( rsync )
      fi

      COMMAND_TO_RUN+=( -d -r "${DIR_TO_SYNC}" gs://"${BUCKET_NAME}" )

      "${COMMAND_TO_RUN[@]}"

      echo
      echo "-> File synchronized to '${BUCKET_NAME}'!"
      echo
  only:
    - /^v.+$/i
  except:
    - branches