include:
  - remote: 'https://raw.githubusercontent.com/jobtome-labs/ci-templates/v2.29.0/docker.yml'
  - remote: 'https://raw.githubusercontent.com/jobtome-labs/ci-templates/v2.29.0/templates/helm.yml'

deploy:quality:helm:branches:
  variables:
    CI_COMMIT_TAG: ${CI_COMMIT_SHORT_SHA}
    GOOGLE_KEY: ${GOOGLE_KEY_QUALITY}
    CLUSTER_NAME: ${CLUSTER_NAME_QUALITY}
    CLUSTER_ZONE: ${CLUSTER_ZONE_QUALITY}
    SECRET_YAML: ${SECRET_YAML_QUALITY}
    NAMESPACE: ${NAMESPACE_QUALITY}
    ENVIRONMENT: quality
    ENVIRONMENT_NAME: quality
    APP_NAME: ${CI_COMMIT_REF_SLUG}
  before_script:
    - db=${CI_COMMIT_REF_SLUG}.kongofluss.services.data.jobtome.host
    - export DOMAIN=$( eval echo \$db )
    - echo ${DOMAIN}
    - |
      # CHECK VARIABLES PHASE
      for var in "GOOGLE_KEY_QUALITY" "CLUSTER_NAME_QUALITY" "CLUSTER_ZONE_QUALITY" "NAMESPACE_QUALITY" "DOMAIN_BRANCH"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done
  only:
    - merge_requests

stop:quality:
  extends: .stop
  stage: stop
  variables:
    CI_COMMIT_TAG: ${CI_COMMIT_SHORT_SHA}
    GOOGLE_KEY: ${GOOGLE_KEY_QUALITY}
    CLUSTER_NAME: ${CLUSTER_NAME_QUALITY}
    CLUSTER_ZONE: ${CLUSTER_ZONE_QUALITY}
    SECRET_YAML: ${SECRET_YAML_QUALITY}
    NAMESPACE: ${NAMESPACE_QUALITY}
    ENVIRONMENT: quality
    ENVIRONMENT_NAME: quality
    APP_NAME: ${CI_COMMIT_REF_SLUG}
  before_script:
    - |
      # CHECK VARIABLES PHASE
      for var in "GOOGLE_KEY_QUALITY" "CLUSTER_NAME_QUALITY" "CLUSTER_ZONE_QUALITY" "NAMESPACE_QUALITY"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done
