lint:docker:
  stage: lint
  image: linuxbandit/hadolint-reviewdog:v1.0.0
  script:
    - |

      COMMAND_TO_RUN="hadolint"
      COMMAND_TO_RUN+=( --trusted-registry ${CI_REGISTRY} )

      if [[ -n "${IGNORE_DOCKER_LINT}" ]]; then
        IGNORE_DOCKER_LINT=( DL3012 )
      fi
      for ign in "${IGNORE_DOCKER_LINT[@]}"; do
        COMMAND_TO_RUN+=( --ignore "${ign}" )
      done

      FINAL_COMMAND=${COMMAND_TO_RUN}

      if [[ -f "Dockerfile" ]]; then
        FINAL_COMMAND+=( ./Dockerfile )
      else
        FINAL_COMMAND+=( ./docker/app/Dockerfile )
        EXTRA_COMMAND+=( ${COMMAND_TO_RUN} ./docker/nginx/Dockerfile )
      fi

      echo
      echo "-> Linting Dockerfile:"
      echo

      if [ "${ENABLE_REVIEWDOG}" = "1" ]; then

        echo
        echo "-> Enabled Review Dog!"
        echo

        if [ -z "${REVIEWDOG_GITLAB_API_TOKEN}" ]; then
          echo
          echo "-> [WARNING] Missing 'REVIEWDOG_GITLAB_API_TOKEN' variable!"
          echo
          exit 1
        fi

        if [ -z "${REVIEWDOG_LEVEL}" ]; then
          REVIEWDOG_LEVEL="warning"
        fi

        "${FINAL_COMMAND[@]}" | reviewdog -name="Hadolint linter" \
          -efm="%f:%l: %m" -diff="git diff master" -reporter=gitlab-mr-discussion -level="${INPUT_LEVEL}"
        if [[ ! -z "${EXTRA_COMMAND}" ]]; then
          echo
          echo "-> Linting support Dockerfile:"
          echo
          "${EXTRA_COMMAND[@]}" | reviewdog -name="Hadolint linter - support Dockerfile" \
            -efm="%f:%l: %m" -diff="git diff master" -reporter=gitlab-mr-discussion -level="${INPUT_LEVEL}"
        fi

      else

        "${FINAL_COMMAND[@]}"
        if [[ ! -z "${EXTRA_COMMAND}" ]]; then
          echo
          echo "-> Linting support Dockerfile:"
          echo
          "${EXTRA_COMMAND[@]}"
        fi

      fi

      echo
      echo "-> Dockerfile(s) checked!"
      echo
